<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mapa CABA - Elecciones 2025</title>
  <link rel="stylesheet" href="./resources/ol.css">
  <script src="./resources/ol.js"></script>
  <script src="layers/Provincias_0.js"></script>
  <script src="styles/Provincias_0_style.js"></script>
  <style>
    html, body, #map { margin: 0; padding: 0; width: 100%; height: 100%; }
    .ol-popup { position: absolute; background: white; padding: 10px; border-radius: 10px; border: 1px solid #ccc; min-width: 250px; }
    .ol-popup-closer { position: absolute; top: 5px; right: 5px; text-decoration: none; }
  </style>
</head>
<body>
  <div id="map">
    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer">‚úñ</a>
      <div id="popup-content"></div>
    </div>
  </div>
  <script>
    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');

    var overlay = new ol.Overlay({
      element: container,
      autoPan: true,
      autoPanAnimation: { duration: 250 }
    });

    closer.onclick = function () {
      overlay.setPosition(undefined);
      closer.blur();
      return false;
    };

    var map = new ol.Map({
      target: 'map',
      layers: [baseLayer, lyr_Provincias_0],
      overlays: [overlay],
      view: new ol.View({ center: ol.proj.fromLonLat([-58.42, -34.6]), zoom: 5 })
    });

    var style_Provincias_0_original = style_Provincias_0;
    style_Provincias_0 = function(feature, resolution) {
      const provincia = feature.get('nprov');
      if (provincia && provincia.toLowerCase().includes('buenos aires') &&
          !provincia.toLowerCase().includes('ciudad') &&
          !provincia.toLowerCase().includes('aut√≥noma') &&
          !provincia.toLowerCase().includes('caba')) {
        return new ol.style.Style({
          fill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0)' }),
          stroke: new ol.style.Stroke({ color: '#999', width: 1 })
        });
      }
      return style_Provincias_0_original(feature, resolution);
    };

    function getBallotType(provincia) {
      const p = provincia.toLowerCase();
      if (p.includes('ciudad aut√≥noma') || p.includes('caba') || p.includes('capital federal')) {
        return 'ELECTR√ìNICA';
      }
      return 'No especificado';
    }

    function getPrimaryStatus(provincia) {
      return { status: 'NO', class: 'primary-no' };
    }

    function getElectionSplit(provincia) {
      return { status: 'S√ç', class: 'primary-yes' };
    }

    map.on('singleclick', function (evt) {
      var feature = map.forEachFeatureAtPixel(evt.pixel, function (feat) { return feat; });
      if (!feature) { overlay.setPosition(undefined); return; }

      var nombre = feature.get('nprov') || '';
      if (nombre.toLowerCase().includes('buenos aires') &&
          !nombre.toLowerCase().includes('ciudad') &&
          !nombre.toLowerCase().includes('aut√≥noma') &&
          !nombre.toLowerCase().includes('caba')) {
        overlay.setPosition(undefined); return;
      }

      if (nombre.toLowerCase().includes('ciudad aut√≥noma') || nombre.toLowerCase().includes('caba')) {
        coal1 = 'LLA: OFICIALISMO'; votos1 = '30';
        coal2 = 'AHORA BUENOS AIRES: PERONISMO LOCAL'; votos2 = '27';
        coal3 = 'BUENOS AIRES PRIMERO: CONFIANZA, PARTIDO FEDERAL'; votos3 = '8';
      } else {
        coal1 = feature.get('_coal1'); votos1 = feature.get('_votos1');
        coal2 = feature.get('_coal2'); votos2 = feature.get('_votos2');
        coal3 = feature.get('_coal3'); votos3 = feature.get('_votos3');
      }

      var html = `
        <strong>${nombre}</strong><br>
        ü•á ${coal1} (${votos1}%)<br>
        ü•à ${coal2} (${votos2}%)<br>
        ü•â ${coal3} (${votos3}%)<br>
        <hr>
        Tipo de boleta: <strong>${getBallotType(nombre)}</strong><br>
        PASO: <strong>${getPrimaryStatus(nombre).status}</strong><br>
        Desdobl√≥ elecci√≥n: <strong>${getElectionSplit(nombre).status}</strong>`;

      content.innerHTML = html;
      overlay.setPosition(evt.coordinate);
    });
  </script>
</body>
</html>
